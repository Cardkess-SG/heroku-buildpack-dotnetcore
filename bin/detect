#!/usr/bin/env bash
# convenience functions
source "$(cd $(dirname $0); cd ..; pwd)"/bin/util/common.sh

if [[ -f "$1/*.csproj" && -f "$1/Startup.cs" && -f "$1/Program.cs" ]]; then
  echo "ASP.NET Core" && exit 0
fi

REQUIRED_FILES=""
if [[ ! -e "$1/*.csproj" ]]; then
	REQUIRED_FILES+="*.csproj"
fi
if [[ ! -e "$1/Startup.cs" ]]; then
 	echo "Startup not found"
	if [[ ${#REQUIRED_FILES} == 0 ]]; then
		echo "Startup1"
		REQUIRED_FILES+="Startup.cs"
	else
		echo "Startup1"
		REQUIRED_FILES+=", Startup.cs"
	fi
fi
if [[ ! -e "$1/Program.cs" ]]; then
	if [[ ${#REQUIRED_FILES} == 0 ]]; then
		REQUIRED_FILES+="Program.cs"
	else
		REQUIRED_FILES+=", Program.cs"
	fi
fi

error <<-EOF
	Application not supported by this buildpack!

	The ASP.NET Core buildpack is set on this application, but was
	unable to detect an ASP.NET Core codebase.

	An ASP.NET Core app requires ${REQUIRED_FILES} file(s) at the root of
	the directory structure.

	If you are trying to deploy an ASP.NET Core application, ensure that ensure that these files(*.csproj, Startup.cs
	and Program.cs) are present at the top level directory. 
	
	This directory has the following files:
	$(ls -1p "$1")
	
	If you are trying to deploy an application written in another
	language, you need to change the list of buildpacks set on your
	Heroku app using the 'heroku buildpacks' command.

	For more information, refer to the following documentation:
	https://devcenter.heroku.com/articles/buildpacks
	https://devcenter.heroku.com/articles/php-support#activation
EOF
exit 1
