#!/usr/bin/env bash

### Configure directories

BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

### Load dependencies

# shellcheck source=util/common.sh
source "$BP_DIR/bin/util/common.sh"

### Declare local variables

declare project_name

# Get project name
project_name="$(get_project_name $1)"

if [[ -f "$1/$project_name.csproj" && -f "$1/Startup.cs" && -f "$1/Program.cs" ]]; then
	declare framework_version="$(get_framework_version $1)"
	print "FV: $framework_version"
	if [ $framework_version < 2.1 ]; then
	   error <<-EOF
		Application framework version $framework_version is not supported by this buildpack!
	   EOF
	else
		echo "ASP.NET Core" && exit 0
	fi
else
	if [[ ${#project_name} -eq 0 ]]; then
		project_name="*"
	fi
	error <<-EOF
		Application not supported by this buildpack!

		The ASP.NET Core buildpack is set on this application, but was unable to detect
		an ASP.NET Core codebase.

		An ASP.NET Core app requires ${PROJECT_NAME}.csproj, Startup.cs and Program.cs
		files at the root of the directory structure.

		If you are trying to deploy an ASP.NET Core application, ensure that ensure that
		these files (${project_name}.csproj, Startup.cs and Program.cs) are present at
		the top level directory. 

		This directory has the following files:
		$(ls -1p "$1")

		If you are trying to deploy an application written in another language, you need
		to change the list of buildpacks set on your Heroku app using the 'heroku buildpacks'
		command.

		For more information, refer to the following documentation:
		https://devcenter.heroku.com/articles/buildpacks
		https://devcenter.heroku.com/articles/php-support#activation
	EOF
fi
exit 1
